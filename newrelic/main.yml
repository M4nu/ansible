---
  - hosts: web

    vars:
        appname: "{{ ansible_fqdn }}"
        php_ini_files: []
        plugins: []
        tmp_plugin_agent_file: /tmp/newrelic_plugin_agent.cfg

    tasks:
      - name: newrelic | install prerequisites
        apt: pkg=python-apt
        tags: newrelic

      - name: newrelic | add repository key
        apt_key: url=https://download.newrelic.com/548C16BF.gpg
        tags: newrelic

      - name: newrelic | add repository
        apt_repository: repo='deb http://apt.newrelic.com/debian/ newrelic non-free'
        tags: newrelic

      - name: newrelic | install
        apt: pkg=newrelic-php5 state=latest update_cache=yes
        tags:
          - newrelic
          - php5

      - name: newrelic | configure php.ini
        lineinfile: dest={{ item }} regexp="newrelic.appname = " line='newrelic.appname = "{{ appname }}"' backup=yes
        with_items: php_ini_files
        tags: newrelic

      - name: newrelic | install dependencies
        apt: pkg=python-pip
        when: plugins > 0
        tags: newrelic

      - name: newrelic | install plugin agent
        pip: name=newrelic-plugin-agent
        when: plugins > 0
        tags: newrelic

      - name: newrelic | copy config file
        fetch: src=/opt/newrelic_plugin_agent/newrelic_plugin_agent.cfg dest={{ tmp_plugin_agent_file }}
        when: plugins > 0
        tags: newrelic

      - copy: src={{ tmp_plugin_agent_file }} dest=/etc/newrelic/newrelic_plugin_agent.cfg
        when: plugins > 0
        tags: newrelic

      - name: newrelic | install plugins
        pip: name=newrelic-plugin-agent[{{ item }}]
        with_items: plugins
        when: plugins > 0
        tags: newrelic
