---
- hosts: web

  vars:
    rules:
      - allow ssh/tcp

  tasks:
    - name: ufw | install
      apt: pkg=ufw state=latest update_cache=yes
      tags: ufw

    - name: ufw | reset
      action: shell ufw --force reset
      tags: ufw

    - name: ufw | disable ping
      lineinfile: dest=/etc/ufw/before.rules regexp="icmp-type {{ item }}" line="-A ufw-before-input -p icmp --icmp-type {{ item }} -j DROP" backup=yes
      with_items:
        - destination-unreachable
        - source-quench
        - time-exceeded
        - parameter-problem
        - echo-request
      tags: ufw

    - name: ufw | configure
      action: shell ufw {{ item }}
      with_items: rules
      tags: ufw

    - name: ufw | enable
      action: shell ufw --force enable
      tags: ufw

    - name: ufw | ensure service is running
      service: name=ufw state=started
      tags: ufw
