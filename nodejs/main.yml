---
  - hosts: web

    vars:
      node_version: "0.10.24"
      node_prefix: "node-v{{ node_version }}"
      node_tarball: "{{ node_prefix }}.tar.gz"
      node_path: "/usr/local"

    tasks:
      - name: nodejs | check installation
        shell: /usr/bin/test "$(node -v 2> /dev/null)" = v{{ node_version }}
        register: installed
        ignore_errors: true
        tags: nodejs

      - name: nodejs | install prerequisite
        apt: pkg={{ item }}
        with_items:
          - make
          - gcc
          - g++
        when: not installed.rc
        tags: nodejs

      - name: nodejs | download
        get_url: url=http://nodejs.org/dist/v{{ node_version }}/{{ node_tarball }} dest=/tmp/
        when: not installed.rc
        tags: nodejs

      - name: nodejs | extract
        command: tar zxf {{ node_tarball }} chdir=/tmp
        when: not installed.rc
        tags: nodejs

      - name: nodejs | configure
        shell: python ./configure --prefix={{ node_path }} chdir=/tmp/{{ node_prefix }}
        when: not installed.rc
        tags: nodejs

      - name: nodejs | compile
        shell: make chdir=/tmp/{{ node_prefix }}/
        when: not installed.rc
        tags: nodejs

      - name: nodejs | install
        shell: make install chdir=/tmp/{{ node_prefix }}/
        when: not installed.rc
        tags: nodejs

      - name: nodejs | add NODE_PATH environment variable
        lineinfile: dest=/etc/environment regexp='^export NODE_PATH=' line='export NODE_PATH=/usr/local/lib/node_modules'
        tags: nodejs
