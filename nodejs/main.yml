---
  - hosts: web

    vars:
      node_version: "0.10.24"
      node_prefix: "node-v{{ node_version }}"
      node_tarball: "{{ node_prefix }}.tar.gz"
      node_path: "/usr/local"

    tasks:
      - name: nodejs | install prerequisite
        apt: pkg={{ item }}
        with_items:
          - make
          - gcc
          - g++
        tags: nodejs

      - name: nodejs | download
        action: get_url url=http://nodejs.org/dist/v{{ node_version }}/{{ node_tarball }} dest=/tmp/
        tags: nodejs

      - name: nodejs | extract
        command: tar zxf {{ node_tarball }} chdir=/tmp
        tags: nodejs

      - name: nodejs | configure
        shell: /usr/bin/python ./configure --prefix={{ node_path }} chdir=/tmp/{{ node_prefix }}
        tags: nodejs

      - name: nodejs | compile
        shell: /usr/bin/make chdir=/tmp/{{ node_prefix }}/
        tags: nodejs

      - name: nodejs | install
        shell: /usr/bin/make install chdir=/tmp/{{ node_prefix }}/
        tags: nodejs

      - name: nodejs | add NODE_PATH environment variable
        lineinfile: dest=/etc/environment regexp='^export NODE_PATH=' line='export NODE_PATH=/usr/local/lib/node_modules'
        tags: nodejs
